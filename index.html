<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNB Document Translation Service</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary-color: #f8fafc;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success-color);
            color: white;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            min-height: calc(100vh - 80px);
        }

        .upload-panel {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .panel-header {
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .panel-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
            background: var(--secondary-color);
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: #eff6ff;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: #dbeafe;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .file-input {
            display: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            transition: border-color 0.2s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--secondary-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
        }

        .file-info {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .file-info-header {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .file-info-label {
            color: var(--text-secondary);
        }

        .file-info-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .streaming-indicator {
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            height: 3px;
            border-radius: 2px;
            margin-bottom: 1rem;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .streaming-content {
            border-left: 3px solid var(--accent-color);
            padding-left: 1rem;
            margin-left: 0.5rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 0 8px 8px 0;
        }

        .chunk-indicator {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .content-panel {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--secondary-color);
        }

        .content-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .content-body {
            padding: 2rem;
            min-height: 400px;
        }

        .welcome-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--accent-color);
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .welcome-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .feature-item {
            padding: 1rem;
            background: var(--secondary-color);
            border-radius: 8px;
            text-align: left;
        }

        .feature-icon {
            color: var(--success-color);
            margin-right: 0.5rem;
        }

        .processing-state {
            text-align: center;
            padding: 3rem 2rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .processing-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .progress-steps {
            background: var(--secondary-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .progress-step:last-child {
            margin-bottom: 0;
        }

        .step-icon {
            width: 20px;
            text-align: center;
        }

        .step-complete {
            color: var(--success-color);
        }

        .step-current {
            color: var(--primary-color);
        }

        .step-pending {
            color: var(--text-secondary);
        }

        .document-display {
            font-family: 'Georgia', serif;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .document-display h1, .document-display h2, .document-display h3 {
            font-family: 'Inter', sans-serif;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .document-display h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .document-display h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .document-display p {
            margin-bottom: 1rem;
            text-align: justify;
        }

        .document-display table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .document-display th, .document-display td {
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: left;
        }

        .document-display th {
            background: var(--secondary-color);
            font-weight: 600;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-info {
            flex: 1;
        }

        .result-stats {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .result-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .edit-mode {
            background: #fffbeb;
            border: 2px solid var(--warning-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }

            .upload-panel {
                position: static;
            }

            .header-content {
                padding: 1rem;
            }

            .logo-text {
                font-size: 1.25rem;
            }

            .result-header {
                flex-direction: column;
                align-items: stretch;
            }

            .result-actions {
                justify-content: stretch;
            }

            .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">P</div>
                <div>
                    <div class="logo-text">PNB Housing Finance</div>
                    <div class="logo-subtitle">Document Translation Service</div>
                </div>
            </div>
            <div class="status-indicator">
                <i class="fas fa-check-circle"></i>
                <span>Service Online</span>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="upload-panel">
            <div class="panel-header">
                <h2 class="panel-title">Upload Document</h2>
                <p class="panel-subtitle">Select a PDF file to translate between English and Hindi</p>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">Drop your PDF here</div>
                <div class="upload-subtext">or click to browse ‚Ä¢ Maximum 15MB</div>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            </div>

            <div class="form-group">
                <label for="targetLang" class="form-label">Translation Direction</label>
                <select id="targetLang" class="form-select">
                    <option value="hi">English ‚Üí Hindi (‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡§º‡•Ä ‚Üí ‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                    <option value="en">Hindi ‚Üí English (‡§π‡§ø‡§Ç‡§¶‡•Ä ‚Üí ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡§º‡•Ä)</option>
                </select>
            </div>

            <button class="btn btn-primary btn-full" id="processBtn" disabled>
                <i class="fas fa-language"></i>
                Start Translation
            </button>

            <div id="fileInfo" class="file-info" style="display: none;">
                <div class="file-info-header">
                    <i class="fas fa-file-pdf"></i>
                    Selected File
                </div>
                <div class="file-info-item">
                    <span class="file-info-label">Name:</span>
                    <span class="file-info-value" id="fileName"></span>
                </div>
                <div class="file-info-item">
                    <span class="file-info-label">Size:</span>
                    <span class="file-info-value" id="fileSize"></span>
                </div>
                <div class="file-info-item">
                    <span class="file-info-label">Type:</span>
                    <span class="file-info-value" id="fileType"></span>
                </div>
            </div>

            <div id="statusMessage" style="display: none;"></div>
        </div>

        <div class="content-panel">
            <div class="content-header">
                <h3 class="content-title" id="contentTitle">Translation Results</h3>
                <p class="content-subtitle" id="contentSubtitle">Your translated document will appear here</p>
            </div>

            <div class="content-body">
                <div id="welcomeState" class="welcome-state">
                    <div class="welcome-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <h3 class="welcome-title">Professional Document Translation</h3>
                    <p class="welcome-text">
                        Upload your PDF document to get started with our AI-powered translation service.
                        We preserve document structure while providing accurate translations.
                    </p>
                    
                    <div class="feature-grid">
                        <div class="feature-item">
                            <i class="fas fa-check feature-icon"></i>
                            Structure Preservation
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check feature-icon"></i>
                            Professional Quality
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check feature-icon"></i>
                            Multiple Formats
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check feature-icon"></i>
                            Fast Processing
                        </div>
                    </div>
                </div>

                <div id="processingState" class="processing-state" style="display: none;">
                    <div class="spinner"></div>
                    <h3 class="processing-title">Processing Your Document</h3>
                    <p class="processing-subtitle">Please wait while we translate your document</p>
                    
                    <div class="progress-steps">
                        <div class="progress-step">
                            <i class="fas fa-upload step-icon" id="step1Icon"></i>
                            <span id="step1Text">Uploading document...</span>
                        </div>
                        <div class="progress-step">
                            <i class="fas fa-robot step-icon" id="step2Icon"></i>
                            <span id="step2Text">AI translation in progress...</span>
                        </div>
                        <div class="progress-step">
                            <i class="fas fa-magic step-icon" id="step3Icon"></i>
                            <span id="step3Text">Formatting and finalizing...</span>
                        </div>
                    </div>
                    
                    <p style="margin-top: 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                        Typical processing time: 15-40 seconds
                    </p>
                </div>

                <div id="resultState" style="display: none;">
                    <div class="result-header">
                        <div class="result-info">
                            <h4 style="margin-bottom: 0.5rem;">Translation Complete</h4>
                            <div class="result-stats" id="resultStats">Ready for download and editing</div>
                        </div>
                        <div class="result-actions">
                            <button class="btn btn-secondary" id="editBtn">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button class="btn btn-success" id="downloadPdfBtn">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button class="btn btn-success" id="downloadDocxBtn">
                                <i class="fas fa-file-word"></i>
                                DOCX
                            </button>
                            <button class="btn btn-success" id="downloadTxtBtn">
                                <i class="fas fa-file-alt"></i>
                                TXT
                            </button>
                        </div>
                    </div>

                    <div class="document-display" id="documentContent" contenteditable="false"></div>

                    <div id="editActions" style="display: none; margin-top: 1rem; text-align: right;">
                        <button class="btn btn-secondary" id="cancelEditBtn">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button class="btn btn-primary" id="saveEditBtn">
                            <i class="fas fa-save"></i>
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class EnterpriseTranslator {
            constructor() {
                // console.log('EnterpriseTranslator constructor called');
                this.selectedFile = null;
                this.translatedDocument = null;
                this.originalText = null;
                this.isEditMode = false;
                this.isProcessing = false; // Prevent duplicate processing
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // File upload
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                // Process button
                // console.log('Adding processBtn event listener');
                document.getElementById('processBtn').addEventListener('click', this.processDocument.bind(this));

                // Download buttons
                document.getElementById('downloadPdfBtn').addEventListener('click', () => this.downloadDocument('pdf'));
                document.getElementById('downloadDocxBtn').addEventListener('click', () => this.downloadDocument('docx'));
                document.getElementById('downloadTxtBtn').addEventListener('click', () => this.downloadDocument('txt'));

                // Edit functionality
                document.getElementById('editBtn').addEventListener('click', this.toggleEditMode.bind(this));
                document.getElementById('saveEditBtn').addEventListener('click', this.saveEdits.bind(this));
                document.getElementById('cancelEditBtn').addEventListener('click', this.cancelEdits.bind(this));
            }

            handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.selectFile(files[0]);
                }
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.selectFile(file);
                }
            }

            selectFile(file) {
                if (file.type !== 'application/pdf') {
                    this.showAlert('Please select a PDF file.', 'error');
                    return;
                }

                if (file.size > 15 * 1024 * 1024) {
                    this.showAlert('File size exceeds 15MB limit. Please select a smaller file.', 'error');
                    return;
                }

                this.selectedFile = file;
                this.displayFileInfo(file);
                document.getElementById('processBtn').disabled = false;
            }

            displayFileInfo(file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                document.getElementById('fileType').textContent = file.type;
                document.getElementById('fileInfo').style.display = 'block';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async processDocument() {
                // Simple frontend tracking
                // const timestamp = new Date().toISOString();
                // console.log(`üî¥ FRONTEND CALL: processDocument at ${timestamp}`);
                
                // console.log('üîµ [PROCESS] processDocument called, isProcessing:', this.isProcessing);
                // console.log('üîµ [PROCESS] Selected file:', this.selectedFile?.name);
                if (!this.selectedFile) return;
                
                // Prevent duplicate processing
                if (this.isProcessing) {
                    // console.log('üü° [PROCESS] Translation already in progress, ignoring duplicate request');
                    return;
                }
                
                // console.log('üü¢ [PROCESS] Starting new translation process');
                this.isProcessing = true;
                this.showProcessingState();
                this.updateProcessingStep(1, 'complete');

                try {
                    const base64File = await this.fileToBase64(this.selectedFile);
                    
                    this.updateProcessingStep(2, 'current');
                    const response = await this.callTranslateAPI(base64File);
                    
                    this.updateProcessingStep(2, 'complete');
                    this.updateProcessingStep(3, 'current');
                    
                    setTimeout(() => {
                        this.updateProcessingStep(3, 'complete');
                        this.translatedDocument = response;
                        this.displayResult(response);
                    }, 1000);

                } catch (error) {
                    console.error('Processing error:', error);
                    this.showAlert('Translation failed: ' + error.message, 'error');
                    this.showWelcomeState();
                } finally {
                    // Reset processing flag
                    this.isProcessing = false;
                }
            }

            updateProcessingStep(step, status) {
                const icon = document.getElementById(`step${step}Icon`);
                const text = document.getElementById(`step${step}Text`);
                
                icon.className = 'step-icon';
                
                if (status === 'complete') {
                    icon.classList.add('fas', 'fa-check', 'step-complete');
                } else if (status === 'current') {
                    icon.classList.add('fas', 'fa-spinner', 'fa-spin', 'step-current');
                } else {
                    icon.classList.add('fas', 'fa-circle', 'step-pending');
                }
            }

            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = () => reject(new Error('File reading failed'));
                    reader.readAsDataURL(file);
                });
            }

            async callTranslateAPI(base64File) {
                // Use streaming translation for better user experience
                return this.callStreamingTranslateAPI(base64File);
            }

            async callStreamingTranslateAPI(base64File) {
                // console.log('üîµ [STREAM] callStreamingTranslateAPI started');
                const targetLang = document.getElementById('targetLang').value;
                // console.log('üîµ [STREAM] Target language:', targetLang);
                const self = this; // Capture 'this' context for use in Promise
                
                return new Promise((resolve, reject) => {
                    let fullTranslation = '';
                    let documentId = '';
                    let processingTime = 0;
                    let detectedLanguage = '';
                    let targetLanguage = '';
                    
                    // Use fetch with streaming response
                    // console.log('üîµ [FETCH] Starting fetch to /translate-stream');
                    fetch('/translate-stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            body: base64File,
                            target_lang: targetLang,
                            template_choice: 'simplified'
                        })
                    }).then(response => {
                        // console.log('üü¢ [FETCH] Response received, status:', response.status);
                        if (!response.ok) {
                            throw new Error('Failed to start translation stream');
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        let buffer = '';
                        
                        const processStream = () => {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    return;
                                }
                                
                                // Add new chunk to buffer
                                buffer += decoder.decode(value, { stream: true });
                                
                                // Process complete lines
                                const lines = buffer.split('\n');
                                buffer = lines.pop(); // Keep incomplete line in buffer
                                
                                for (const line of lines) {
                                    if (line.trim().startsWith('data: ')) {
                                        try {
                                            const jsonStr = line.trim().slice(6); // Remove 'data: '
                                            if (jsonStr.trim()) {
                                                const data = JSON.parse(jsonStr);
                                                // console.log('üü¢ [STREAM] Streaming data received:', data.type, data);
                                                self.handleStreamingData(data);
                                                
                                                if (data.type === 'start') {
                                                    // console.log('üü¢ [EVENT] START event - Document ID:', data.document_id);
                                                    documentId = data.document_id;
                                                } else if (data.type === 'chunk') {
                                                    // console.log('üü¢ [EVENT] CHUNK event - Length:', data.chunk?.length, 'Total so far:', fullTranslation.length + (data.chunk?.length || 0));
                                                    fullTranslation += data.chunk;
                                                    // Update UI with streaming content
                                                    self.updateStreamingContent(fullTranslation, data);
                                                } else if (data.type === 'final') {
                                                    // console.log('üü¢ [EVENT] FINAL event - Processing complete');
                                                    // Don't overwrite fullTranslation - use accumulated streaming content
                                                    // This prevents duplicate processing of the same document
                                                    processingTime = data.processing_time;
                                                    detectedLanguage = data.detected_language;
                                                    targetLanguage = data.target_language;
                                                    documentId = data.document_id;
                                                    
                                                    // console.log('üü¢ [RESOLVE] Resolving promise with fullTranslation length:', fullTranslation.length);
                                                    resolve({
                                                        success: true,
                                                        document_id: documentId,
                                                        detected_language: detectedLanguage,
                                                        target_language: targetLanguage,
                                                        translated_document: fullTranslation,
                                                        processing_time: processingTime,
                                                        message: data.message
                                                    });
                                                    return;
                                                } else if (data.type === 'error') {
                                                    reject(new Error(data.error));
                                                    return;
                                                }
                                            }
                                        } catch (e) {
                                            // console.warn('Failed to parse streaming data:', line, 'Error:', e);
                                        }
                                    }
                                }
                                
                                processStream();
                            }).catch(reject);
                        };
                        
                        processStream();
                    }).catch(reject);
                });
            }

            handleStreamingData(data) {
                // console.log('Handling streaming data:', data.type);
                
                if (data.type === 'start') {
                    this.showAlert('Translation started...', 'info');
                    this.updateProcessingStep(2, 'current'); // Step 2 is translation
                    // Show result panel immediately when streaming starts
                    this.showResultState();
                    
                    // Debug: Check if elements exist
                    // const contentEl = document.getElementById('documentContent');
                    // const statsEl = document.getElementById('resultStats');
                    // console.log('UI Elements check:', {
                    //     documentContent: !!contentEl,
                    //     resultStats: !!statsEl,
                    //     resultState: document.getElementById('resultState').style.display
                    // });
                } else if (data.type === 'chunk') {
                    // Update progress indicator
                    const progress = Math.min(95, (data.progress / 10000) * 100); // Rough progress estimate
                    this.updateTranslationProgress(progress, data.chunk_count);
                } else if (data.type === 'retry') {
                    this.showAlert(`Retrying... (${data.attempt}/${data.max_retries})`, 'warning');
                } else if (data.type === 'final') {
                    this.updateProcessingStep(2, 'complete'); // Translation complete
                    this.updateProcessingStep(3, 'complete'); // All done
                } else if (data.type === 'error') {
                    this.showAlert(`Error: ${data.error}`, 'error');
                }
            }

            updateStreamingContent(fullText, chunkData) {
                // console.log('üîµ [UPDATE] updateStreamingContent called - Length:', fullText.length, 'characters');
                
                // Ensure result panel is visible
                this.showResultState();
                
                // Update the document content area with streaming text
                const content = this.formatDocumentText(fullText);
                const contentElement = document.getElementById('documentContent');
                
                if (contentElement) {
                    // console.log('üü¢ [UPDATE] Setting innerHTML - Previous length:', contentElement.innerHTML.length, 'New length:', content.length);
                    contentElement.innerHTML = content;
                    // console.log('üü¢ [UPDATE] Content updated in DOM successfully');
                } else {
                    console.error('‚ùå [UPDATE] documentContent element not found!');
                }
                
                // Update stats
                const wordCount = fullText.trim().split(/\s+/).length;
                const charCount = fullText.length;
                
                const statsElement = document.getElementById('resultStats');
                if (statsElement) {
                    statsElement.innerHTML = `
                        Translating... ‚Ä¢ 
                        ${wordCount.toLocaleString()} words ‚Ä¢ 
                        ${charCount.toLocaleString()} characters ‚Ä¢
                        ${chunkData.chunk_count || 0} chunks received
                    `;
                }
                
                // Auto-scroll to bottom to show new content
                if (contentElement) {
                    contentElement.scrollTop = contentElement.scrollHeight;
                }
            }

            updateTranslationProgress(percentage, chunkCount) {
                // Update any progress indicators
                const progressText = `Translating... ${Math.round(percentage)}% (${chunkCount} chunks)`;
                
                // Update step status with progress
                const translateStep = document.querySelector('[data-step="translate"] .step-text');
                if (translateStep) {
                    translateStep.textContent = progressText;
                }
            }

            // Fallback method for non-streaming translation
            async callLegacyTranslateAPI(base64File) {
                const targetLang = document.getElementById('targetLang').value;
                
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        body: base64File,
                        target_lang: targetLang,
                        template_choice: 'simplified'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Translation failed');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Unknown error occurred');
                }

                return result;
            }

            displayResult(response) {
                // console.log('üîµ [DISPLAY] displayResult called');
                // console.log('üîµ [DISPLAY] Response document length:', response.translated_document?.length);
                
                // DON'T overwrite content - streaming already populated it progressively
                // This prevents the visual "double processing" effect
                // const contentElement = document.getElementById('documentContent');
                // console.log('üîµ [DISPLAY] Current DOM content length:', contentElement?.innerHTML?.length);
                // console.log('üü° [DISPLAY] NOT updating content - streaming already populated it');
                
                // Only update final statistics and metadata
                const wordCount = response.translated_document.trim().split(/\s+/).length;
                const charCount = response.translated_document.length;
                const processingTime = response.processing_time ? `${response.processing_time.toFixed(1)}s` : '';
                
                // console.log('üü¢ [DISPLAY] Updating final stats only');
                // Update stats to show final completion status (remove "Translating..." indicator)
                document.getElementById('resultStats').innerHTML = `
                    ${response.detected_language || 'Source'} ‚Üí ${response.target_language || 'Target'} ‚Ä¢ 
                    ${wordCount.toLocaleString()} words ‚Ä¢ 
                    ${charCount.toLocaleString()} characters
                    ${processingTime ? ` ‚Ä¢ ${processingTime}` : ''}
                `;

                this.originalText = response.translated_document;
                this.showResultState(); // Ensure result panel is visible
                this.showAlert('Translation completed successfully!', 'success');
                // console.log('üü¢ [DISPLAY] displayResult completed');
            }

            formatDocumentText(text) {
                if (!text || text.trim().length === 0) {
                    return '<p style="color: var(--text-secondary); font-style: italic;">No content to display</p>';
                }

                let formatted = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^(\d+\.\s.+)$/gm, '<div style="margin: 8px 0; padding-left: 20px;">$1</div>')
                    .replace(/^[‚Ä¢\-]\s(.+)$/gm, '<div style="margin: 8px 0; padding-left: 20px;">‚Ä¢ $1</div>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');

                return '<p>' + formatted + '</p>';
            }

            toggleEditMode() {
                const content = document.getElementById('documentContent');
                const editActions = document.getElementById('editActions');
                
                if (!this.isEditMode) {
                    this.isEditMode = true;
                    content.contentEditable = true;
                    content.classList.add('edit-mode');
                    content.textContent = this.translatedDocument.translated_document;
                    editActions.style.display = 'block';
                    content.focus();
                } else {
                    this.cancelEdits();
                }
            }

            saveEdits() {
                const content = document.getElementById('documentContent');
                const editActions = document.getElementById('editActions');
                
                this.translatedDocument.translated_document = content.textContent;
                this.isEditMode = false;
                content.contentEditable = false;
                content.classList.remove('edit-mode');
                
                const formatted = this.formatDocumentText(content.textContent);
                content.innerHTML = formatted;
                
                editActions.style.display = 'none';
                this.showAlert('Changes saved successfully!', 'success');
            }

            cancelEdits() {
                const content = document.getElementById('documentContent');
                const editActions = document.getElementById('editActions');
                
                this.isEditMode = false;
                content.contentEditable = false;
                content.classList.remove('edit-mode');
                
                const formatted = this.formatDocumentText(this.originalText);
                content.innerHTML = formatted;
                
                editActions.style.display = 'none';
            }

            async downloadDocument(format) {
                if (!this.translatedDocument) {
                    this.showAlert('No document available for download', 'error');
                    return;
                }

                // Show loading state
                const button = document.getElementById(`download${format.charAt(0).toUpperCase() + format.slice(1)}Btn`);
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                button.disabled = true;

                try {
                    const response = await fetch('/download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            translated_text: this.translatedDocument.translated_document,
                            source_lang: this.translatedDocument.detected_language || 'English',
                            target_lang: this.translatedDocument.target_language || 'Hindi',
                            format: format
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Download failed');
                    }

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `professional_translation.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showAlert(`${format.toUpperCase()} document downloaded successfully!`, 'success');

                } catch (error) {
                    console.error('Download error:', error);
                    this.showAlert(`Failed to download ${format.toUpperCase()}: ${error.message}`, 'error');
                } finally {
                    // Restore button state
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            showWelcomeState() {
                document.getElementById('welcomeState').style.display = 'block';
                document.getElementById('processingState').style.display = 'none';
                document.getElementById('resultState').style.display = 'none';
            }

            showProcessingState() {
                document.getElementById('welcomeState').style.display = 'none';
                document.getElementById('processingState').style.display = 'block';
                document.getElementById('resultState').style.display = 'none';
                
                // Reset steps
                for (let i = 1; i <= 3; i++) {
                    this.updateProcessingStep(i, 'pending');
                }
            }

            showResultState() {
                document.getElementById('welcomeState').style.display = 'none';
                document.getElementById('processingState').style.display = 'none';
                document.getElementById('resultState').style.display = 'block';
            }

            showAlert(message, type) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.className = `alert alert-${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new EnterpriseTranslator();
        });
    </script>
</body>
</html>